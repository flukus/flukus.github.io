<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ORM vs SQL Part 3 - Filtering | Proactively Lazy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The final of the 3 basic scenarios that nearly every application will need is filtering, the where clause in an sql statement. An application will have to display a list of products in a category, fil">
<meta property="og:type" content="article">
<meta property="og:title" content="ORM vs SQL Part 3 - Filtering">
<meta property="og:url" content="http://flukus.github.io/2013/12/15/2013_12_15_ORM-vs-SQL-3-Filtering/index.html">
<meta property="og:site_name" content="Proactively Lazy">
<meta property="og:description" content="The final of the 3 basic scenarios that nearly every application will need is filtering, the where clause in an sql statement. An application will have to display a list of products in a category, fil">
<meta property="og:updated_time" content="2015-08-11T23:38:44.869Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ORM vs SQL Part 3 - Filtering">
<meta name="twitter:description" content="The final of the 3 basic scenarios that nearly every application will need is filtering, the where clause in an sql statement. An application will have to display a list of products in a category, fil">
  
    <link rel="alternative" href="/atom.xml" title="Proactively Lazy" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Proactively Lazy</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://flukus.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2013_12_15_ORM-vs-SQL-3-Filtering" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/12/15/2013_12_15_ORM-vs-SQL-3-Filtering/" class="article-date">
  <time datetime="2013-12-14T13:00:00.000Z" itemprop="datePublished">2013-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ORM vs SQL Part 3 - Filtering
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The final of the 3 basic scenarios that nearly every application will need is filtering, the where clause in an sql statement. An application will have to display a list of products in a category, filter a list of users by email address, get an order by it&#39;s id or something along those lines. It&#39;s practically impossible to write an application with out it.</p>
<p>The most interesting thing about filtering is that it&#39;s rather simple to write a query that can handle all your scenarios. The problem is that it renders all your carefully planned indexes irrelevant or worse. Sql server can be quite fickle about using indexes, depending on the cardinality, execution plan and phase of the moon. I&#39;ll show just how stupid it can sometimes be.</p>
<p>#Filtering with an ORM</p>
<p>Once again we can build our dynamic query with an ORM quite simply:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var query = Session.QueryOver&lt;User&gt;();</span><br><span class="line">if (string.IsNullOrEmpty(filterId))</span><br><span class="line">  query = query.Where(x =&amp;amp;gt; x.Id == filterId);</span><br><span class="line">if (string.IsNullOrEmpty(filterLastName))</span><br><span class="line">  query = query.Where(Restrictions.On&lt;User&gt;(x =&gt; x.LastName).IsLike(filterLastName));</span><br><span class="line">if (string.IsNullOrEmpty(filterEmail))</span><br><span class="line">  query = query.Where(Restrictions.On&lt;User&gt;(x =&gt; x.Email).IsLike(filterEmail));</span><br><span class="line">var result = query.List();</span><br></pre></td></tr></table></figure>
<p>Once again, our ORM builds a prepared statement for every unique situation which can make use of the appropriate indexes if we have any. It&#39;s not necessarily fast, that will depend on your performance tuning, but it&#39;s as fast as it can be.</p>
<p>#Filtering with Sql</p>
<p>Dynamically filtering with sql is also quite simple. To get the same functionality as above:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> TOP(<span class="number">20</span>) <span class="keyword">id</span>, lastName, firstName, email</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">users</span></span><br><span class="line"><span class="keyword">where</span> <span class="comment">--lastName = '21250A22-6B3F-452C-9FE3-7EBBF216B13C'</span></span><br><span class="line">  (@<span class="keyword">id</span> <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">OR</span> @<span class="keyword">id</span> = @<span class="keyword">id</span>)</span><br><span class="line"><span class="keyword">AND</span></span><br><span class="line">  (@lastName <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">or</span> lastName <span class="keyword">Like</span> @lastName + <span class="string">'%'</span>)</span><br><span class="line"><span class="keyword">AND</span></span><br><span class="line">  (@email <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">or</span> email <span class="keyword">LIKE</span> @email + <span class="string">'%'</span>)</span><br></pre></td></tr></table></figure>
<p>This is much more elegant than our solutions in the past two posts. The first problem is, what if you want some other logic, if you want to search by last name or email then this won&#39;t work. You&#39;ll either need something far more elaborate or you&#39;ll need several identical queries. The other problem is that it may not use an index, or even worse, will use the wrong index.</p>
<p>#What index will this use?</p>
<p>Well the answer is it depends on a lot of things. The first query, collected statistics and moon phases being the primary influences. I don&#39;t know about you, but I like my systems to perform consistently. Assuming the above query is in a stored procedure:</p>
<ul>
<li>execute the procedure with @id=null, @lastName=&#39;abc&#39;, @email=null</li>
<li>Query finishes in ~280ms. The index on lastName was used</li>
<li>execute the procedure with @id=null, @lastName=null, @email=&#39;abc&#39;</li>
<li>Query finishes in ~11000ms, still using the index on lastName, not the index on email</li>
<li>execute the procedure with @id=&#39;C15BAFAA-B772-4863-8849-00413B531C29&#39;, @lastName=null, @email=null</li>
<li>Query finishes in ~11000ms, still using the index on lastName, not the primary key index</li>
<li>execute the procedure with @id=null, @lastName=null, @email=null</li>
<li>Query finishes in ~12000ms, still using the index on lastName</li>
</ul>
<p>Deleting our indexes and repeating the queries in the same order takes ~50ms, ~60ms, ~20ms, 20ms.
So a query like this will not only render many of your indexes useless but can cause the wrong index to be used, which is much worse. Again the tailor made query that an ORM will generate will have much better performance than a generic one that you can create.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://flukus.github.io/2013/12/15/2013_12_15_ORM-vs-SQL-3-Filtering/" data-id="cin15ftgn000huouydzjf2kru" class="article-share-link">Share</a>
      
        <a href="http://flukus.github.io/2013/12/15/2013_12_15_ORM-vs-SQL-3-Filtering/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/orm/">orm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/">sql</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/08/19/2014_08_19_Android-Take-back-your-builds/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Android - Take back your Builds
        
      </div>
    </a>
  
  
    <a href="/2013/12/12/2013_12_12_ORM-vs-SQL-2-Ordering/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ORM vs SQL Part 2 - Ordering</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AAATest/">AAATest</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app-harbor/">app harbor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/">architecture</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/build/">build</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c#</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/general/">general</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/general-programming/">general programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/integration-test/">integration test</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/msbuild/">msbuild</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nServiceBus/">nServiceBus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nant/">nant</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nunit/">nunit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orm/">orm</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/powershell/">powershell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/psake/">psake</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scm/">scm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/">sql</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unit-test/">unit test</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AAATest/" style="font-size: 12.5px;">AAATest</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/app-harbor/" style="font-size: 10px;">app harbor</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/build/" style="font-size: 20px;">build</a> <a href="/tags/c/" style="font-size: 15px;">c#</a> <a href="/tags/general/" style="font-size: 10px;">general</a> <a href="/tags/general-programming/" style="font-size: 10px;">general programming</a> <a href="/tags/integration-test/" style="font-size: 10px;">integration test</a> <a href="/tags/msbuild/" style="font-size: 15px;">msbuild</a> <a href="/tags/nServiceBus/" style="font-size: 10px;">nServiceBus</a> <a href="/tags/nant/" style="font-size: 12.5px;">nant</a> <a href="/tags/nunit/" style="font-size: 10px;">nunit</a> <a href="/tags/orm/" style="font-size: 15px;">orm</a> <a href="/tags/powershell/" style="font-size: 12.5px;">powershell</a> <a href="/tags/psake/" style="font-size: 10px;">psake</a> <a href="/tags/scm/" style="font-size: 10px;">scm</a> <a href="/tags/sql/" style="font-size: 17.5px;">sql</a> <a href="/tags/unit-test/" style="font-size: 15px;">unit test</a> <a href="/tags/vim/" style="font-size: 12.5px;">vim</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/08/">August 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">June 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/04/15/2016_04_15_Background-Builds-with-Vim-8/">Background Builds with Vim 8</a>
          </li>
        
          <li>
            <a href="/2015/08/12/2013_12_10_ORM-vs-SQL-1-Paging/">ORM vs SQL Part 1 - Paging</a>
          </li>
        
          <li>
            <a href="/2015/07/24/2015_07_24_Simple-Abstractions/">Simple Abstractions</a>
          </li>
        
          <li>
            <a href="/2015/07/09/2015_07_09-Interfaces-for-Data/">Simple Interfaces for Data</a>
          </li>
        
          <li>
            <a href="/2015/07/03/2015_07_03-Vim-errorformat-Demystified/">Vim errorformat Demystified</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Luke Usher<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'proactivelylazy';
  
  var disqus_url = 'http://flukus.github.io/2013/12/15/2013_12_15_ORM-vs-SQL-3-Filtering/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>