<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Practical MSBuild - Database Migrations | Proactively Lazy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="I&amp;#39;d like to propose an addendum Greenspuns Tenth Rule. Any sufficiently complicated c# program contains an ad hoc, informally-specified, bug-ridden, slow implementation of half of Fluent Migrator.">
<meta property="og:type" content="article">
<meta property="og:title" content="Practical MSBuild - Database Migrations">
<meta property="og:url" content="http://flukus.github.io/2011/06/10/2011_05_17_Practical-MSBuild---Database-Migrations/index.html">
<meta property="og:site_name" content="Proactively Lazy">
<meta property="og:description" content="I&amp;#39;d like to propose an addendum Greenspuns Tenth Rule. Any sufficiently complicated c# program contains an ad hoc, informally-specified, bug-ridden, slow implementation of half of Fluent Migrator.">
<meta property="og:updated_time" content="2016-02-13T21:44:48.696Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Practical MSBuild - Database Migrations">
<meta name="twitter:description" content="I&amp;#39;d like to propose an addendum Greenspuns Tenth Rule. Any sufficiently complicated c# program contains an ad hoc, informally-specified, bug-ridden, slow implementation of half of Fluent Migrator.">
  
    <link rel="alternative" href="/atom.xml" title="Proactively Lazy" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Proactively Lazy</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://flukus.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2011_05_17_Practical-MSBuild---Database-Migrations" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2011/06/10/2011_05_17_Practical-MSBuild---Database-Migrations/" class="article-date">
  <time datetime="2011-06-09T14:00:00.000Z" itemprop="datePublished">2011-06-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Practical MSBuild - Database Migrations
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I&#39;d like to propose an addendum <a href="http://en.wikipedia.org/wiki/Greenspun&#39;s_Tenth_Rule" target="_blank" rel="external">Greenspuns Tenth Rule</a>. Any sufficiently complicated c# program contains an ad hoc, informally-specified, bug-ridden, slow implementation of half of <a href="https://github.com/schambers/fluentmigrator/wiki" target="_blank" rel="external">Fluent Migrator</a>.</p>
<p>Keeping database structures up to date with other developers, not to mention production and testing environments is an Incredibly common problem and Fluent Migrator is a seriously good library that helps solve this problem elegantly. Amongst other eco systems the idea of migrations is well accepted, ruby <a href="http://guides.rubyonrails.org/migrations.html" target="_blank" rel="external">rails migrations</a>, java has <a href="http://migrate4j.sourceforge.net/" target="_blank" rel="external">migrate4j</a> and python has <a href="http://pypi.python.org/pypi/yoyo-migrations" target="_blank" rel="external">yoyo migrations</a>, but for some reason the idea has been slow to gain traction in the c# world.</p>
<p>One of the barriers to adoption so far has been documentation, so in this article I want to show how to leverage Fluent Migrator. There are plenty of good articles on writing migrations so I will only touch on that briefly. Instead, I want to show how to use it as an integral part of the build process, how to avoid some common pitfalls and how to integrate it within the greater project lifecycle.</p>
<p>#Whats Wrong With *</p>
<p>For start I&#39;m going to assume that sharing a database between developers is bad idea. Someone may need to make large scale changes that disrupt other developers. Having long running feature branches is impossible (without another database) and it does nothing to solve the problems your eventually going to face at deployment time. This is obviously not an optimal solution.</p>
<p>Of the many half solutions I&#39;ve seen, simple sql scripts are the most common. Advanced versions of this have sequentially numbered scripts and some sort of batch process to run them in order, in other words, half of Fluent Migrator. Often they will contain checks to ensure there not executed multiple times (so the same column doesn&#39;t get added twice for instance), another 1/4 of Fluent Migrator.</p>
<p>From a simplicity point of view this may seem rather enticing but doesn&#39;t work nearly as well in practice. This approach isn&#39;t very branch/merge friendly and migrations will need to be run in an explicitly defined order. Sql is also particularly verbose language, especially for structural changes, how many of you can remember the syntax to create a table with an index of the top of your head?</p>
<p>Other solutions I&#39;ve come across, such as Visual Studio database projects, suffer from similar shortcomings and are deeply rooted in the old school &quot;quarterly release&quot; type project, where a once off upgrade script is written for every release. One particularly notable &quot;solution&quot; I came across was using data dude to generate patch scripts. This was so slow, cumbersome and error prone I still shudder just thinking about it.</p>
<p>With that in mind here are the goals for this solution:</p>
<ul>
<li>Local - Upgrades should be able to run anywhere from the developers PC to the server.</li>
<li>Fast - This is a freebie (with Fluent Migrator) most migrations will take seconds from start to finish.</li>
<li>Frequent - Once fast and easy are solved you&#39;ll want to run them much more frequently.</li>
<li>Production Ready - Migrations should be able to be deployed at a moments notice. This is a by product of the above three.</li>
</ul>
<p>#Step 1 - Backup, Delete, Restore, Obfuscate</p>
<p>The first few requirements are basically &quot;filling in the gaps&quot;, handling the tasks that Fluent Migrator doesn&#39;t deal with. Never the less they are an important part of the overall process. In these examples I will be using Sqlite because it&#39;s simple, file based nature makes it easy to follow the examples without getting lost in the details. Here are the important bits of the database.build file (I&#39;ll post the whole file at the end), this is created with the same techniques I outlined <a href="2011_04_22_Practical-MSBuild---Flexible-Configuration.md">here</a>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbCreate"</span> &gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- SqlLite won't actually create the file because it is an empty database but it is neccessary with other databases --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Exec</span> <span class="attr">Command</span>=<span class="string">"$(dbSqlitePath)\Sqlite3.exe $(dbPath)\$(dbName) "</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbBackup"</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Copy</span> <span class="attr">SourceFiles</span>=<span class="string">"$(dbPath)\$(dbName)"</span> <span class="attr">DestinationFiles</span>=<span class="string">"$(dbBackupPath)\$(dbBackupName)"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbRestore"</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Copy</span> <span class="attr">SourceFiles</span>=<span class="string">"$(dbRestoreSource)"</span> <span class="attr">DestinationFiles</span>=<span class="string">"$(dbPath)\$(dbName)"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbDelete"</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Delete</span> <span class="attr">Files</span>=<span class="string">"$(dbPath)\$(dbName)"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbObfuscate"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>Backup and delete should be fairly self explanatory but restore needs a bit more explanation. I&#39;ve found it more useful to start from a &quot;known good&quot; version of the database rather than starting from scratch every time. For this I strongly favor using backups from production databases. This gives us much more realistic data to work with when we&#39;re developing, quantatively and qualitatively. Failing that, a database with somewhat realistic looking test data would do.</p>
<p>A pleasant side effect of using real production data is that, by the time a release comes around, we have run our data migrations dozens/hundreds/thousands of times. This will give much more confidence with the process and make releases much less stressful. An emergency patch can also be tested and verified using much the same process as a full release (because it&#39;s so quick and easy), so no more cowboy live patches.</p>
<p>Obviously if we have real data it may need obfuscating due to any number of privacy issues that could pop up. Security on developer workstations probably isn&#39;t as thorough as it is on the server and we don&#39;t want people taking sensitive data out of the office. However, I have purposely left the task empty, simply because it will vary so much from project to project.</p>
<p>#Step 2 - Writing a Migration</p>
<p>Before any migrations can be written they need a project, a Fluent Migrator script is simply c# library (dll) after all. Usually it gets named something like YourProjectName.Migrations. Here is my recommended database structure:</p>
<p>TODO: link images
<a href="http://4.bp.blogspot.com/-OkcjXN6YYeg/TcSWGgd-tDI/AAAAAAAAAA4/2Slq03DFriQ/s1600/pms_migrations.png" target="_blank" rel="external">http://4.bp.blogspot.com/-OkcjXN6YYeg/TcSWGgd-tDI/AAAAAAAAAA4/2Slq03DFriQ/s1600/pms_migrations.png</a>
<a href="http://4.bp.blogspot.com/-OkcjXN6YYeg/TcSWGgd-tDI/AAAAAAAAAA4/2Slq03DFriQ/s320/pms_migrations.png" target="_blank" rel="external">http://4.bp.blogspot.com/-OkcjXN6YYeg/TcSWGgd-tDI/AAAAAAAAAA4/2Slq03DFriQ/s320/pms_migrations.png</a></p>
<p>As you can see each revision will get it&#39;s own folder, sooner or later you will have enough migrations to warrant this. The other thing of note is that each version has a data and structure folder. The structure folder will contain the bread and butter of Fluent Migrator, adding/removing tables and columns. The data folder exists to make it easier to find migrations much create/update/delete any reference data that our applications will inevitably have.</p>
<p>Finally some actual code. This example is a simple migration that creates a products table with a name, description and primary key:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Migration(0101201104301422)]</span><br><span class="line">public class _01_01_2011_04_30_14_22_AddProductTable : Migration &#123;</span><br><span class="line">  public override void Up() &#123;</span><br><span class="line">    Create.Table(&quot;products&quot;)</span><br><span class="line">      .WithColumn(&quot;product&quot;).AsInt32().PrimaryKey().Identity()</span><br><span class="line">      .WithColumn(&quot;name&quot;).AsString(128).NotNullable()</span><br><span class="line">      .WithColumn(&quot;description&quot;).AsString(int.MaxValue).NotNullable();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public override void Down() &#123;</span><br><span class="line">    Delete.Table(&quot;products&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The interesting thing here is the version number which is is probably the least intuitive part of this article. The convention used is: {major}{minor}{year}{month}{day}{hour}{minute}. Major/Minor are our product versions, this ensures that migrations are executed in the order the product is developed. This is particularly important if a project has long running branches with features and bug fixes. The rest is the time the migration is created, hours and minutes simply ensure (almost always) that there are no collisions with other developers writing migrations concurrently.</p>
<p>This numbering scheme will save much frustration at merge time.</p>
<p>#Step 3 - Running Migrations</p>
<p>At the time of writing the msbuild task isn&#39;t working with the version of Fluent Migrator I&#39;m using, it also isn&#39;t documented so I&#39;ll be using using the exec task coupled with the Fluent Migrator console runner. One other thing to remember is that Fluent Migrator is currently a c# 3.5 project so all migrations projects need to be as well. Here is the MS Build task to execute the migrations:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbMigrate"</span> <span class="attr">DependsOnTargets</span>=<span class="string">"compile"</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Exec</span> <span class="attr">Command</span>=<span class="string">"$(dbMigratorPath)\Migrate.exe --target=src\app\PMSBuild.Migrations\bin\debug\PMSBuild.Migrations.dll --db=sqlite --c=&amp;quot;Data Source=$(dbPath)\$(dbName);Version=3;&amp;quot; --verbose=true --version=$(dbVersion)"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>There are quite a few properties here but it&#39;s the dbVersion property which is the most important. The default is set (at the top of the script) to 0, which will run all migrations. Because the precedence rules I outlined in my last article are used (<a href="#">Practical MS Build - Flexible Configuration</a>), it is easy to migrate to a specific version if needed. From the command line simply specify a new value for the property:</p>
<pre><code>msbuild project.build /target:dbMigrate /property:dbVersion=0101201104301422
</code></pre><p>#Step 4 - Migrating Data</p>
<p>One of the most cited reasons for dismissing Fluent Migrator is that it doesn&#39;t handle data migrations. This is throwing the baby out with the bath water. It is true that Fluent Migrator doesn&#39;t handle this but it does provide an excellent framework to execute and track such migrations.</p>
<p>Because we&#39;re <a href="http://www.codinghorror.com/blog/2004/10/a-pragmatic-quick-reference.html" target="_blank" rel="external">pragmatic programmers</a> that use the right tool for the job, we&#39;ll want to modify our data with a language made for just that: SQL. Fortunately Fluent Migrator allows us to execute arbitrary sql, we just need a little bit of organization and self discipline.</p>
<p>Lets say a migration needs to add a meta column to the products table created above and that we need to populate it with the description, to serve as a place holder until a real person edits it. The first part is easy, just create another migration which adds the column:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Migration(0101201105021944)]</span><br><span class="line">public class _01_01_2011_05_02_19_44_AddMetaColumnToProduct : Migration &#123;</span><br><span class="line">  public override void Up() &#123;</span><br><span class="line">    Create.Column(&quot;meta&quot;).OnTable(&quot;products&quot;)</span><br><span class="line">      .AsString(int.MaxValue)</span><br><span class="line">      .NotNullable()</span><br><span class="line">      .WithDefaultValue(&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  public override void Down() &#123;</span><br><span class="line">    Delete.Column(&quot;meta&quot;).FromTable(&quot;products&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next we need to create an sql file to hold our script. Generally I stick to the same naming conventions used for the migration classes so I created 01_01_2011_05_02_19_44_PopulateMetaOnMigrations.sql in the same directory as the migration classes:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products</span><br><span class="line"><span class="keyword">SET</span> meta = [description]</span><br></pre></td></tr></table></figure>
<p>This is about as straight forward as sql scripts get. Next I create a resource (0101_SqlMigrations.resx) file in the version directory and add the above script as a file resource. This compiles the script into the dll which simplifies things when we need to use our migrations externally (installers etc).</p>
<p>The last thing to do is modify the migration class above with a line to execute the file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public override void Up() &#123;</span><br><span class="line">  /* previous code */</span><br><span class="line">  Execute.Sql(_0101_SqlMigrations._01_01_2011_05_02_19_44_PopulateMetaOnMigrations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#Wrapping Up</p>
<p>A fast, flexible and complete solution to manage databases. With this approach you will never again will you fear long running branches. Never gain have to develop against a database being modified by others. Most importantly, never again dread database upgrades at release time. Once you get used to a solution like this going back to anything else will seem slow and archaic and error prone.</p>
<p>As promised here is the complete database.build script:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">encoding</span>=<span class="string">"utf-8"</span>? /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">xmlns</span>=<span class="string">"http://schemas.microsoft.com/developer/msbuild/2003"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dbName</span> <span class="attr">Condition</span>=<span class="string">"'$(dbName)' == ''"</span>&gt;</span>Test.db<span class="tag">&lt;/<span class="name">dbName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbPath</span> <span class="attr">Condition</span>=<span class="string">"'$(dbPath)' == ''"</span>&gt;</span>database<span class="tag">&lt;/<span class="name">dbPath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbSqlitePath</span> <span class="attr">Condition</span>=<span class="string">"'$(dbSqlitePath)' == ''"</span>&gt;</span>c:/Program Files/Sqlite<span class="tag">&lt;/<span class="name">dbSqlitePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbBackupPath</span> <span class="attr">Condition</span>=<span class="string">"'$(dbBackupPath)' == ''"</span>&gt;</span>d:\databases\backups<span class="tag">&lt;/<span class="name">dbBackupPath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbBackupName</span> <span class="attr">Condition</span>=<span class="string">"'$(dbBackupName)' == ''"</span>&gt;</span>Test_Backup.db<span class="tag">&lt;/<span class="name">dbBackupName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbRestoreSource</span> <span class="attr">Condition</span>=<span class="string">"'$(dbRestoreSource)' == ''"</span>&gt;</span>d:\databases\backups\Prod_2011_04_30.db<span class="tag">&lt;/<span class="name">dbRestoreSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbMigratorPath</span> <span class="attr">Condition</span>=<span class="string">"'$(dbMigratorPath)' == ''"</span> &gt;</span>packages\FluentMigrator.0.9.0.0\tools<span class="tag">&lt;/<span class="name">dbMigratorPath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbVersion</span> <span class="attr">Condition</span>=<span class="string">"'$(dbVersion)' == ''"</span> &gt;</span>0<span class="tag">&lt;/<span class="name">dbVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbEcho"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Message</span> <span class="attr">Text</span>=<span class="string">"dbName: $(dbName)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Message</span> <span class="attr">Text</span>=<span class="string">"dbPath: $(dbPath)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Message</span> <span class="attr">Text</span>=<span class="string">"dbSqlitePath: $(dbSqlitePath)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Message</span> <span class="attr">Text</span>=<span class="string">"dbBackupPath: $(dbBackupPath)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Message</span> <span class="attr">Text</span>=<span class="string">"dbBackupName: $(dbBackupName)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Message</span> <span class="attr">Text</span>=<span class="string">"dbRestoreSource: $(dbRestoreSource)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Message</span> <span class="attr">Text</span>=<span class="string">"dbMigratorPath: $(dbMigratorPath)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--&lt;UsingTask TaskName="FluentMigrator.MSBuild.Migrate" AssemblyFile="lib\FluentMigrator\FluentMigrator.MSBuild.dll"/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbCreate"</span> &gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- This won't actually create the file because it is an empty database --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Exec</span> <span class="attr">Command</span>=<span class="string">"$(dbSqlitePath)\Sqlite3.exe $(dbPath)\$(dbName) "</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbBackup"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Copy</span> <span class="attr">SourceFiles</span>=<span class="string">"$(dbPath)\$(dbName)"</span> <span class="attr">DestinationFiles</span>=<span class="string">"$(dbBackupPath)\$(dbBackupName)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbRestore"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Copy</span> <span class="attr">SourceFiles</span>=<span class="string">"$(dbRestoreSource)"</span> <span class="attr">DestinationFiles</span>=<span class="string">"$(dbPath)\$(dbName)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbDelete"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Delete</span> <span class="attr">Files</span>=<span class="string">"$(dbPath)\$(dbName)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbObfuscate"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">"dbMigrate"</span> <span class="attr">DependsOnTargets</span>=<span class="string">"compile"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Exec</span> <span class="attr">Command</span>=<span class="string">"$(dbMigratorPath)\Migrate.exe --target=src\app\PMSBuild.Migrations\bin\debug\PMSBuild.Migrations.dll --db=sqlite --c=&amp;amp;amp;quot;Data Source=$(dbPath)\$(dbName);Version=3;&amp;amp;amp;quot; --verbose=true --version=$(dbVersion)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://flukus.github.io/2011/06/10/2011_05_17_Practical-MSBuild---Database-Migrations/" data-id="cin15ftfs0002uouyyzp72mx2" class="article-share-link">Share</a>
      
        <a href="http://flukus.github.io/2011/06/10/2011_05_17_Practical-MSBuild---Database-Migrations/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/build/">build</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/msbuild/">msbuild</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/">sql</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2011/08/04/2011_08_04_Code-Coverage--Unit-vs-Integration-tests/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Your checkin process is Ruining your checkin process
        
      </div>
    </a>
  
  
    <a href="/2011/06/10/2011_06_10_Practical-MSBuild---Avoiding Spaghetti-Builds/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Practical MSBuild - Avoiding Spaghetti Builds</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AAATest/">AAATest</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app-harbor/">app harbor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/">architecture</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/build/">build</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c#</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/general/">general</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/general-programming/">general programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/integration-test/">integration test</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/msbuild/">msbuild</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nServiceBus/">nServiceBus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nant/">nant</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nunit/">nunit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orm/">orm</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/powershell/">powershell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/psake/">psake</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scm/">scm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/">sql</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unit-test/">unit test</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AAATest/" style="font-size: 12.5px;">AAATest</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/app-harbor/" style="font-size: 10px;">app harbor</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/build/" style="font-size: 20px;">build</a> <a href="/tags/c/" style="font-size: 15px;">c#</a> <a href="/tags/general/" style="font-size: 10px;">general</a> <a href="/tags/general-programming/" style="font-size: 10px;">general programming</a> <a href="/tags/integration-test/" style="font-size: 10px;">integration test</a> <a href="/tags/msbuild/" style="font-size: 15px;">msbuild</a> <a href="/tags/nServiceBus/" style="font-size: 10px;">nServiceBus</a> <a href="/tags/nant/" style="font-size: 12.5px;">nant</a> <a href="/tags/nunit/" style="font-size: 10px;">nunit</a> <a href="/tags/orm/" style="font-size: 15px;">orm</a> <a href="/tags/powershell/" style="font-size: 12.5px;">powershell</a> <a href="/tags/psake/" style="font-size: 10px;">psake</a> <a href="/tags/scm/" style="font-size: 10px;">scm</a> <a href="/tags/sql/" style="font-size: 17.5px;">sql</a> <a href="/tags/unit-test/" style="font-size: 15px;">unit test</a> <a href="/tags/vim/" style="font-size: 12.5px;">vim</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/08/">August 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">June 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/04/15/2016_04_15_Background-Builds-with-Vim-8/">Background Builds with Vim 8</a>
          </li>
        
          <li>
            <a href="/2015/08/12/2013_12_10_ORM-vs-SQL-1-Paging/">ORM vs SQL Part 1 - Paging</a>
          </li>
        
          <li>
            <a href="/2015/07/24/2015_07_24_Simple-Abstractions/">Simple Abstractions</a>
          </li>
        
          <li>
            <a href="/2015/07/09/2015_07_09-Interfaces-for-Data/">Simple Interfaces for Data</a>
          </li>
        
          <li>
            <a href="/2015/07/03/2015_07_03-Vim-errorformat-Demystified/">Vim errorformat Demystified</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Luke Usher<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'proactivelylazy';
  
  var disqus_url = 'http://flukus.github.io/2011/06/10/2011_05_17_Practical-MSBuild---Database-Migrations/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>